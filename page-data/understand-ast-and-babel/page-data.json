{"componentChunkName":"component---src-templates-blog-post-js","path":"/understand-ast-and-babel/","result":{"data":{"site":{"siteMetadata":{"title":"Coyeah's Blog","siteUrl":"https://www.coyeah.top"}},"markdownRemark":{"id":"531727aa-6909-5dd0-aef5-ed784c60971b","excerpt":"AST，Abstract Syntax Tree，抽象语法树。 以前在准备面试的时候，在看 webpack 原理和 babel 原理的时候都提到 AST，但是对于 AST 的概念是一知半解的。趁这个机会捋一捋这一块的知识点。 简单描述一下 webpack…","html":"<p>AST，Abstract Syntax Tree，抽象语法树。</p>\n<p>以前在准备面试的时候，在看 webpack 原理和 babel 原理的时候都提到 AST，但是对于 AST 的概念是一知半解的。趁这个机会捋一捋这一块的知识点。</p>\n<p>简单描述一下 webpack 的原理，就是：</p>\n<ol>\n<li>读取文件分析模块依赖</li>\n<li>对模块进行解析执行（深度遍历）</li>\n<li>针对不同的模块使用相对应的 loader</li>\n<li>编译模块，生成抽象语法树（AST）</li>\n<li>循环遍历 AST 树，拼接输出 JavaScript</li>\n</ol>\n<p>再简单的描述下 babel 的原理，就是：babel 解析成 AST，然后用插件更改 AST，最后由 babel 输出代码。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bf07cf61ed8caa3dcf942844295e11d0/c1b63/ast.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.77215189873418%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAACOUlEQVQozyWOzW/ScByH+78YFZW4QYGOsk1gQ9wLlLYUxq+wrh2UtTBe5G2w7MXtsovRzW0mmqgnD568mJl48eTR/8HE6/onfD9m8/DkkzyHTx5uNVMmY6MNc/M5cnkTkmpCKVSR00xkVQNqoXqLolmQ8xbkgomiXsea7kAt1sAqDTjOGK3mPgyjQ9yaWSF31EC92yJJNSmrGKQWq1TWe6SzPklFmzJajZSSQ4VKkyxjjxjrkFKwSNaqJGubpLgblG2XkLF04kandbr4McTotUvamg2tZGNZLqO7dY5x8xNyJQe61cXG1hB5fRsHnS9oOS+hWw2wiot8sYrpgxm6c3kPUyOBuOErhy6+jzE5bZFZ7aDb34e57qBm9eC6O7DtBrbbE+wfnsBxmmi6E/Q7Bxj09tDuH2Kyd4LYcZJ8Z34E+yJx4zcOvf+5i93zFqVVGypzcD3awUfdxaS/hL9X82CsAsYY/nyL4Xgng1/OEL97I8jWADnWBH8UI9+7R/8LrYFOu5cObQ7WaT6Zo4WUQleWTUeySTUzTVdvEyQrBZKkPH09i1O7LtGHskuf6y1a0WqUWmEU3J4j/4sgTddE4u7eF+B7IGI6kEBYWIQgpuHjE8jkDRTZFviohOjsMmZiSwgIGRhWBzKzIcSzmI+vQoimEAmnEOIXwfNJcA/90Wv/VMx7HJjzAnz8liD/xIuKTz1x9pkXEZJeWFjw+PDNJr3ZuSVPjKW9UDhx60KRBY+PJL1AKH7zcf0P4MVKIAACxuYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"babel原理图\"\n        title=\"babel原理图\"\n        src=\"/static/bf07cf61ed8caa3dcf942844295e11d0/f058b/ast.png\"\n        srcset=\"/static/bf07cf61ed8caa3dcf942844295e11d0/c26ae/ast.png 158w,\n/static/bf07cf61ed8caa3dcf942844295e11d0/6bdcf/ast.png 315w,\n/static/bf07cf61ed8caa3dcf942844295e11d0/f058b/ast.png 630w,\n/static/bf07cf61ed8caa3dcf942844295e11d0/40601/ast.png 945w,\n/static/bf07cf61ed8caa3dcf942844295e11d0/c1b63/ast.png 1200w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>什么是 AST</h2>\n<blockquote>\n<p>It is a hierarchical program representation that presents source code structure according to the grammar of a programming language, each AST node corresponds to an item of a source code.</p>\n</blockquote>\n<p>懵了？</p>\n<p>在计算机科学中，抽象语法树（abstract syntax tree 或者缩写为 AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式，这里特指编程语言的源代码。树上的每个节点都表示源代码中的一种结构。</p>\n<p>AST 是对源代码结构的一种抽象表现，称得上是“抽象”，即不会对真实语法中的每一个细节都记录下来。</p>\n<h2>AST 的使用场景</h2>\n<ul>\n<li>JavaScript 反编译</li>\n<li>Babel 编译 ES6 语法</li>\n<li>代码高亮</li>\n<li>关键词匹配</li>\n<li>作用域判断</li>\n<li>代码压缩</li>\n</ul>\n<h2>AST 的解析过程</h2>\n<p>AST 解析和编译器所做的事并不同，相对来说更加简单（保住了发量）。编译器需要把高级编程语言转换成二进制，而 AST 解析只需要关注 <strong>词法分析</strong> 和用 <strong>语法分析</strong> 这两个关键的步骤。</p>\n<h3>词法分析</h3>\n<p>词法分析，就是把一句话拆分成词语。既不让丢失原本的意思，又能够拆分成最小词法单元。JavaScript 可以识别的最小词法单元：空格、注释、字符串、数字、标识符、运算符、括号。</p>\n<h4>举个栗子</h4>\n<p><code class=\"language-text\">用纸笔记录生活的美好。</code> > JavaScript 文件</p>\n<p>babel working now…</p>\n<p><code class=\"language-text\">用</code>、<code class=\"language-text\">纸笔</code>、<code class=\"language-text\">记录</code>、<code class=\"language-text\">生活</code>、<code class=\"language-text\">的</code>、<code class=\"language-text\">美好</code> > AST</p>\n<h4>用代码说明</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"if 1 > 0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这样的一串代码，在 babel 看来就是这个样子的：<code class=\"language-text\">if</code>、<code class=\"language-text\">(</code>、<code class=\"language-text\">1</code>、<code class=\"language-text\">&gt;</code>、<code class=\"language-text\">0</code>、<code class=\"language-text\">)</code>、<code class=\"language-text\">{</code>、<code class=\"language-text\">alert</code>、<code class=\"language-text\">(</code>、<code class=\"language-text\">&quot;if 1 &gt; 0&quot;</code>、<code class=\"language-text\">)</code>、<code class=\"language-text\">;</code>、<code class=\"language-text\">}</code>、<code class=\"language-text\">;</code>。省去了空格。</p>\n<p>这个有点太简单了，走个专业点的。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">[</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"\\n\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"identifier\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"if\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\" \"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"parens\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"(\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"number\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\" \"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"operator\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\">\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\" \"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"number\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"parens\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\")\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\" \"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"brace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"{\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"\\n \"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"identifier\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"alert\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"parens\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"(\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"if 1 > 0\\\"\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"parens\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\")\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"sep\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\";\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"\\n\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"brace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"}\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"\\n\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h3>语法分析</h3>\n<p>经历过词法分析的分词步骤后，语法分析便是把这些个分词进行立体化的组合。确认有多重意义的词语最终是什么意思、多个词语之间有什么关系以及又应该再哪里断句等。表现出来的就是有个从属关系，Object 中有着 Children， Children 中包含着子 Object。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> <span class=\"token string\">'AST'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>经过语法分析后呈现的 AST，来看看通过解析成 AST 最真实的样子。也可以通过<a href=\"https://astexplorer.net/\">在线编辑器</a>来体验一下。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Program\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"end\"</span><span class=\"token operator\">:</span> <span class=\"token number\">19</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"body\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VariableDeclaration\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"end\"</span><span class=\"token operator\">:</span> <span class=\"token number\">19</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"declarations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VariableDeclarator\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"end\"</span><span class=\"token operator\">:</span> <span class=\"token number\">18</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Identifier\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"end\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"text\"</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"init\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Literal\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token number\">13</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"end\"</span><span class=\"token operator\">:</span> <span class=\"token number\">18</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AST\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"raw\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"AST\\\"\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"kind\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"const\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"sourceType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"module\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>简析下图中的内容：</p>\n<ul>\n<li><strong>type</strong> - 描述该语句的类型</li>\n<li><strong>kind</strong> - 变量声明的关键字</li>\n<li><strong>declaration</strong> - 声明的内容，用数组的形式体现，每一项都是一个对象</li>\n<li><strong>name</strong> - 变量名称</li>\n<li><strong>type</strong> - 变量类型</li>\n<li><strong>value</strong> - 变量的值，不带引号</li>\n<li><strong>row</strong> - 变量的值，带引号</li>\n</ul>\n<h2>动手做做看——Babel插件</h2>\n<p>首先得介绍两个关键库</p>\n<ul>\n<li><strong>babel-core</strong> - babel 核心库，用于实现核心的转换引擎</li>\n<li><strong>babel-types</strong> - 实现类型转换，生成 AST 节点</li>\n</ul>\n<h3>简单入手</h3>\n<p>从简单的入手，我们先让第三方类库为我们完成解析、遍历和生成的工作。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> esprima <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'esprima'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">//解析 JavaScript 的语法的包</span>\n<span class=\"token keyword\">const</span> estraverse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'estraverse'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">//遍历树的包</span>\n<span class=\"token keyword\">const</span> escodegen <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'escodegen'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">//生成新的树的包</span></code></pre></div>\n<p>从打印出来的结构可以看得出来，解析出 AST 树是经过词法和语法分析后的立体结构。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> code <span class=\"token operator\">=</span> <span class=\"token string\">'let sum = () => {};'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">AST</span> <span class=\"token operator\">=</span> esprima<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 解析</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/*\nScript {\n  type: 'Program',\n  body:\n   [ VariableDeclaration {\n       type: 'VariableDeclaration',\n       declarations: [Array],\n       kind: 'let' } ],\n  sourceType: 'script' }\n */</span></code></pre></div>\n<p>AST 遍历过程中每个节点都被访问了两次，一进一出各一次。每次访问都对<code class=\"language-text\">node.name</code>进行一次改写操作。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 遍历</span>\nestraverse<span class=\"token punctuation\">.</span><span class=\"token function\">traverse</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AST</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'enter > '</span><span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">.</span>name <span class=\"token operator\">+=</span> <span class=\"token string\">'_enter'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">leave</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'leave > '</span><span class=\"token punctuation\">,</span> node<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'Identifier'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">.</span>name <span class=\"token operator\">+=</span> <span class=\"token string\">'_leave'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/*\nenter >  Program\nenter >  VariableDeclaration\nenter >  VariableDeclarator\nenter >  Identifier\nleave >  Identifier\nenter >  ArrowFunctionExpression\nenter >  BlockStatement\nleave >  BlockStatement\nleave >  ArrowFunctionExpression\nleave >  VariableDeclarator\nleave >  VariableDeclaration\nleave >  Program\n */</span></code></pre></div>\n<p>最后的部分就是生成新的代码。函数的变量名称也被改变了。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> escodegen<span class=\"token punctuation\">.</span><span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/*\nlet sum_enter_leave = () => {};\n */</span></code></pre></div>\n<h3>正式开始做第一个插件（预计算和箭头函数）</h3>\n<p><code class=\"language-text\">index.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> compute <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./compute'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> arrow <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./arrow'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> code1 <span class=\"token operator\">=</span> <span class=\"token string\">'const result = 1 + 2 + 3 + 4 + 5 + 6;'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> code2 <span class=\"token operator\">=</span> <span class=\"token string\">'let sum = (a,b) => a+b;'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> babel<span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>code1<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    compute<span class=\"token punctuation\">,</span>\n    arrow<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">compute.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> visitor <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">BinaryExpression</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">path</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> result<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 判断表调是两遍是否都是数字</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">isNumericLiteral</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> types<span class=\"token punctuation\">.</span><span class=\"token function\">isNumericLiteral</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">\"+\"</span><span class=\"token operator\">:</span>\n          result <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> node<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">\"-\"</span><span class=\"token operator\">:</span>\n          result <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">.</span>value <span class=\"token operator\">-</span> ndoe<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">\"*\"</span><span class=\"token operator\">:</span>\n          result <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">.</span>value <span class=\"token operator\">*</span> ndoe<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">\"/\"</span><span class=\"token operator\">:</span>\n          result <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">.</span>value <span class=\"token operator\">/</span> ndoe<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string\">\"**\"</span><span class=\"token operator\">:</span>\n          <span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token operator\">--</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            result <span class=\"token operator\">=</span> result <span class=\"token operator\">||</span> node<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n            result <span class=\"token operator\">=</span> result <span class=\"token operator\">*</span> node<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 如果上面的运算有结果的话</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 把表达式节点替换成number字面量</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">numericLiteral</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 向上递归的方式遍历父级节点，判断父级节点是否是运算</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span>parentPath<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> <span class=\"token string\">'BinaryExpression'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      visitor<span class=\"token punctuation\">.</span><span class=\"token function\">BinaryExpression</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span>parentPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  visitor<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">arrow.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> visitor <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">ArrowFunctionExpression</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">path</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 如果这个节点是箭头函数的节点的话，进行替换工作</span>\n    <span class=\"token keyword\">let</span> params <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> blockStatement <span class=\"token operator\">=</span> types<span class=\"token punctuation\">.</span><span class=\"token function\">blockStatement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">returnStatement</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> func <span class=\"token operator\">=</span> types<span class=\"token punctuation\">.</span><span class=\"token function\">functionExpression</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> blockStatement<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    path<span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  visitor<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Key Point</h4>\n<ul>\n<li><strong>visitor</strong> - 当Babel处理一个节点时，是以 visitor 的形式获取节点信息，并进行相关操作，这种方式是通过一个 visitor 对象来完成的，在 visitor 对象中定义了对于各种节点的访问函数，这样就可以针对不同的节点做出不同的处理。我们编写的 Babel 插件其实也是通过定义一个实例化 visitor 对象处理一系列的 AST 节点来完成我们对代码的修改操作。</li>\n<li><strong>path</strong> - 每次访问节点方法时，都会传入一个 path 参数，这个参数中包含了节点的信息以及节点和所在的位置，以供对特定节点进行操作。具体来说 Path 是表示两个节点之间连接的对象。这个对象不仅包含了当前节点的信息，也有当前节点的父节点的信息，同时也包含了添加、更新、移动和删除节点有关的其他很多方法。</li>\n<li><strong>state</strong> - 每次访问节点方法时传入的第二个参数</li>\n<li><strong>square</strong> - 作用域</li>\n</ul>\n<h2>总结</h2>\n<p>在网路上找了很多资料学习而来，还在学习阶段。对于 AST 原理并没有很高盛莫测，却有着探索的必要。以上是我对抽象语法树的理解，若有什么不正确的地方。恳请斧正！</p>\n<p>参考资料：<a href=\"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md#toc-introduction\">Babel 插件手册</a>\n项目传送门：<a href=\"https://github.com/Coyeah/demo-babel-plugin\">传送门</a></p>","frontmatter":{"title":"浅谈对AST的理解，动手写写Babel插件","date":"March 08, 2019","description":null}},"previous":{"fields":{"slug":"/shallow-copy-and-deep-copy-in-js/"},"frontmatter":{"title":"JavaScript中的浅拷贝与深拷贝"}},"next":{"fields":{"slug":"/processing-the-binary-stream/"},"frontmatter":{"title":"处理二进制流的小白玩法"}}},"pageContext":{"id":"531727aa-6909-5dd0-aef5-ed784c60971b","previousPostId":"294895cc-2c3b-5a92-98ee-15c6c67b8a8f","nextPostId":"6ee914a0-c963-56af-be93-ceeb95d493a8"}},"staticQueryHashes":["2841359383","3274528899","4152100472"]}